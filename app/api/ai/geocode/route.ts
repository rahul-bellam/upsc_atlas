import { NextResponse } from 'next/server'
export async function GET(req){ const q=new URL(req.url).searchParams.get('q')||''; if(!q) return NextResponse.json({ error:'missing q' }, { status:400 }); try{ const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`); const j=await r.json(); if(j && j[0]) return NextResponse.json({ lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon), display_name: j[0].display_name }) }catch(e){ console.warn(e) } const openaiKey=process.env.OPENAI_API_KEY; if(!openaiKey) return NextResponse.json({ error:'geocode failed' }, { status:500 }); try{ const prompt=`Extract coordinates for this place in JSON {lat:..., lng:..., display_name:"..."} if known, otherwise {}. Place: ${q}`; const r=await fetch('https://api.openai.com/v1/chat/completions', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${openaiKey}` }, body: JSON.stringify({ model:'gpt-4o-mini', messages:[{ role:'user', content: prompt }], max_tokens:120 }) }); const j=await r.json(); const text=j?.choices?.[0]?.message?.content||''; const m=text.match(/\{[\s\S]*\}/); if(m) return NextResponse.json(JSON.parse(m[0])) }catch(e){ console.error(e) } return NextResponse.json({ error:'unable to geocode' }, { status:500 }) }
