import { NextResponse } from 'next/server'
export async function GET(req){ const url=new URL(req.url); const q=url.searchParams.get('q')||''; if(!q) return NextResponse.json({ error:'missing q' }, { status:400 }); const provider=(process.env.AI_PROVIDER||'openai').toLowerCase(); const prompt=`Provide structured sections separated by ===. Context:, Geography:, Why:, Impact:, Solutions:, UPSC: for the place/topic: ${q}`; if(provider==='deepseek'){ const key=process.env.DEEPSEEK_API_KEY; const base=process.env.DEEPSEEK_BASE_URL||'https://api.deepseek.com'; if(!key) return NextResponse.json({ error:'no deepseek key' }, { status:400 }); const r=await fetch(`${base}/v1/chat/completions`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${key}` }, body: JSON.stringify({ model:'deepseek-reasoner', messages:[{ role:'user', content: prompt }], max_tokens:800 }) }); const j=await r.json(); const text=j?.choices?.[0]?.message?.content||''; const parts=text.split(/===+/).map(s=>s.trim()); return NextResponse.json({ provider:'deepseek', raw:text, parsed:parts }) } const openaiKey=process.env.OPENAI_API_KEY; if(!openaiKey) return NextResponse.json({ error:'no openai key' }, { status:400 }); const r=await fetch('https://api.openai.com/v1/chat/completions', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${openaiKey}` }, body: JSON.stringify({ model:'gpt-4o-mini', messages:[{ role:'user', content: prompt }], max_tokens:800 }) }); const j=await r.json(); const text=j?.choices?.[0]?.message?.content||''; const parts=text.split(/===+/).map(s=>s.trim()); const out={ raw:text }; parts.forEach(p=>{ if(p.toLowerCase().startsWith('context')) out.context=p.replace(/^context[:\-\s]*/i,''); else if(p.toLowerCase().startsWith('geography')) out.geography=p.replace(/^geography[:\-\s]*/i,''); else if(p.toLowerCase().startsWith('why')) out.why=p.replace(/^why[:\-\s]*/i,''); else if(p.toLowerCase().startsWith('impact')) out.impact=p.replace(/^impact[:\-\s]*/i,''); else if(p.toLowerCase().startsWith('solutions')) out.solutions=p.replace(/^solutions[:\-\s]*/i,''); else if(p.toLowerCase().startsWith('upsc')) out.upsc=p.replace(/^upsc[:\-\s]*/i,'') }); return NextResponse.json({ provider:'openai', ...out }) }
